#!/usr/bin/env zsh

# litellm-copilot - LiteLLM proxy for GitHub Copilot models
#
# Usage: litellm-copilot [--port <number>]
#
# Options:
#   --port <number>  Port to run the proxy on (default: 4000)
#
# Environment variables:
#   COPILOT_PROXY_TOKEN_CMD - Command that outputs your GitHub PAT (required)
#   COPILOT_MODEL           - Model to use (optional, skips fzf selection)
#
# Example token commands for your shell profile:
#   # 1Password:
#   export COPILOT_PROXY_TOKEN_CMD='op read "op://Vault/Item/field"'
#   # macOS Keychain:
#   export COPILOT_PROXY_TOKEN_CMD='security find-generic-password -a "$USER" -s copilot-token -w'

# Default port
PORT=4000

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --port)
      PORT="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: litellm-copilot [--port <number>]"
      exit 1
      ;;
  esac
done

# Model list last updated: 2026-01-11

# List of supported models
MODELS=(
  "claude-haiku-4.5"
  "claude-opus-4.5"
  "claude-sonnet-4"
  "claude-sonnet-4.5"
  "gemini-2.5-pro"
  "gemini-3-flash-preview"
  "gemini-3-pro-preview"
  "gpt-4.1"
  "gpt-4o"
  "gpt-5"
  "gpt-5-codex"
  "gpt-5-mini"
  "gpt-5.1"
  "gpt-5.1-codex"
  "gpt-5.1-codex-max"
  "gpt-5.1-codex-mini"
  "gpt-5.2"
  "grok-code-fast-1"
)

# Check for COPILOT_PROXY_TOKEN_CMD
if [[ -z "$COPILOT_PROXY_TOKEN_CMD" ]]; then
  echo "Error: COPILOT_PROXY_TOKEN_CMD is not set"
  echo "Set it in your shell profile. Examples:"
  echo '  # 1Password:'
  echo '  export COPILOT_PROXY_TOKEN_CMD='\''op read "op://Vault/Item/field"'\'''
  echo '  # macOS Keychain:'
  echo '  export COPILOT_PROXY_TOKEN_CMD='\''security find-generic-password -a "$USER" -s copilot-token -w'\'''
  exit 1
fi

# Select model: use COPILOT_MODEL if set, otherwise use fzf
if [[ -n "$COPILOT_MODEL" ]]; then
  SELECTED_MODEL="$COPILOT_MODEL"
else
  # Check if fzf is installed
  if ! command -v fzf &> /dev/null; then
    echo "Error: fzf is not installed (needed when COPILOT_MODEL is not set)"
    echo "Install it with: brew install fzf"
    exit 1
  fi

  # Use fzf to select a model
  SELECTED_MODEL=$(printf '%s\n' "${MODELS[@]}" | fzf --prompt="Select a model: " --height=40% --reverse)

  # Exit if no model was selected
  if [[ -z "$SELECTED_MODEL" ]]; then
    echo "No model selected. Exiting."
    exit 1
  fi
fi

echo "Starting litellm with model: $SELECTED_MODEL"

# Get token using the configured command
TOKEN=$(eval "$COPILOT_PROXY_TOKEN_CMD") || exit 1
export GITHUB_TOKEN="$TOKEN"

# Get the directory where this script is located
SCRIPT_DIR="${0:a:h}"
CONFIG_FILE="$SCRIPT_DIR/config.yaml"

litellm --config "$CONFIG_FILE" --model github_copilot/$SELECTED_MODEL --port $PORT
