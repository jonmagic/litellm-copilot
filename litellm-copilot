#!/usr/bin/env zsh

# litellm-copilot - LiteLLM proxy for GitHub Copilot models
#
# Usage: litellm-copilot [--port <number>]
#
# Options:
#   --port <number>  Port to run the proxy on (default: 4000)
#
# Environment variables:
#   COPILOT_PROXY_TOKEN_CMD - Command that outputs your GitHub PAT (required)
#
# Example token commands for your shell profile:
#   # 1Password:
#   export COPILOT_PROXY_TOKEN_CMD='op read "op://Vault/Item/field"'
#   # macOS Keychain:
#   export COPILOT_PROXY_TOKEN_CMD='security find-generic-password -a "$USER" -s copilot-token -w'

# Default port
PORT=4000

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --port)
      PORT="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: litellm-copilot [--port <number>]"
      exit 1
      ;;
  esac
done

# Check for COPILOT_PROXY_TOKEN_CMD
if [[ -z "$COPILOT_PROXY_TOKEN_CMD" ]]; then
  echo "Error: COPILOT_PROXY_TOKEN_CMD is not set"
  echo "Set it in your shell profile. Examples:"
  echo '  # 1Password:'
  echo '  export COPILOT_PROXY_TOKEN_CMD='\''op read "op://Vault/Item/field"'\'''
  echo '  # macOS Keychain:'
  echo '  export COPILOT_PROXY_TOKEN_CMD='\''security find-generic-password -a "$USER" -s copilot-token -w'\'''
  exit 1
fi

# Get token using the configured command
TOKEN=$(eval "$COPILOT_PROXY_TOKEN_CMD") || exit 1
export GITHUB_TOKEN="$TOKEN"

# Get the directory where this script is located
SCRIPT_DIR="${0:a:h}"
CONFIG_FILE="$SCRIPT_DIR/config.yaml"

# Check for uv
if ! command -v uvx &> /dev/null; then
  echo "Error: uv is not installed"
  echo "Install it with: brew install uv (macOS) or curl -LsSf https://astral.sh/uv/install.sh | sh (Linux)"
  exit 1
fi

echo "Starting litellm proxy on port $PORT..."

# Pin to Python 3.13 because uvloop doesn't support Python 3.14+
uvx --python 3.13 --from 'litellm[proxy]' litellm --config "$CONFIG_FILE" --port $PORT
